<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.fastboot.server.producems.mapper.DemandMapper">
    <resultMap id="demandItemNodes" type="com.example.fastboot.server.producems.model.DemandItem">
        <id property="id" column="demandItemId"/>
        <result property="guid" column="guid"/>
        <result property="demandConfiemedState" column="demandConfiemedState"/>
        <result property="nodeGuid" column="nodeGuid"/>
        <result property="questionAndNotes" column="questionAndNotes"/>
        <result property="severity" column="severity"/>
        <result property="eventStream" column="eventStream"/>
        <association property="nodes" javaType="com.example.fastboot.server.producems.model.Nodes">
            <id column="nodesId" property="id"/>
            <result property="name" column="name"/>
            <result property="guid" column="nodeGuid"/>
        </association>
    </resultMap>
    <insert id="insertDemandtrace">
        INSERT INTO `demandtrace`(guid, produceGuid)
        VALUES (#{guid}, #{produceGuid}, 1);
    </insert>
    <insert id="addDemandtraceAll">
        INSERT INTO `demandtrace`(guid,projectGuid,produceGuid,
                                  demandType,demandDescription,proposer,submitName,
                                  submitTime,priority,dealState)
        VALUES( #{demandtrace.guid}, #{demandtrace.projectGuid},#{demandtrace.produceGuid},
                #{demandtrace.demandType},#{demandtrace.demandDescription}, #{demandtrace.proposer},
                #{demandtrace.submitName},#{demandtrace.submitTime}, #{demandtrace.priority},1
              );
    </insert>
    <update id="updateDemandConfirmDetail">
        update demanditem
        set demandConfiemedState=#{demandConfiemedState},
            questionAndNotes=#{questionAndNotes},
            severity            = #{severity}
        where guid = #{guid}
    </update>
    <update id="updateDemandTranceConfirmName">
        update demandtrace
        set demandConfirmName=#{userName}
        where nodeGuid = #{nodeGuid}
    </update>
    <update id="updateDealState">
        update demanditem
        set demandConfiemedState=#{status}
        where nodeGuid = #{nodeGuid}
    </update>
    <update id="updateDemandTraceDetailDes">
        update `demandtrace`
        set detailDescription= #{detailDescription}
        where guid = #{guid}
    </update>
    <update id="updateDemandtrace">
        update `demandtrace`
        set
        <if test="demandtrace.finishTime!=null">
            finishTime=#{demandtrace.finishTime},
        </if>
        <if test="demandtrace.finishTime==null">
            finishTime='1970-01-01 00:00:00',
        </if>
        <if test="demandtrace.submitTime!=null">
            submitTime=#{demandtrace.submitTime},
        </if>
        <if test="demandtrace.submitTime==null">
            submitTime='1970-01-01 00:00:00',
        </if>
        guid=#{demandtrace.guid},
        projectGuid=#{demandtrace.projectGuid},
        demandType=#{demandtrace.demandType},
        demandDescription=#{demandtrace.demandDescription},
        proposer=#{demandtrace.proposer},
        submitName=#{demandtrace.submitName},
        priority=#{demandtrace.priority},
        techManager=#{demandtrace.techManager},
        reviewFlag=#{demandtrace.reviewFlag},
        demandName=#{demandtrace.demandName},
        reviewName=#{demandtrace.reviewName},
        developName=#{demandtrace.developName},
        devlopFinishName=#{demandtrace.devlopFinishName},
        demandConfirmName=#{demandtrace.demandConfirmName},
        checkName=#{demandtrace.checkName},
        dealState=#{demandtrace.dealState},
        notes=#{demandtrace.notes}
        where guid = #{demandtrace.guid}
    </update>
    <delete id="deleteteDemandTrace">
        update demandtrace
        set deleteFlag=1
        where guid = #{guid}
    </delete>
    <select id="getDemand" resultType="com.example.fastboot.server.producems.model.Demandmanage">
        select * from demandmanage
        <where>
            deleteFlag=0
            <if test="guid !=null and guid!=''">
                and guid = #{guid}
            </if>
            <if test="produceGuid !=null and produceGuid!=''">
                and produceGuid=#{produceGuid}
            </if>
            <if test="objective !=null and objective!=''">
                and objective=#{objective}
            </if>
            and deleteFlag=0
        </where>
    </select>
    <select id="countDemandConfirm" resultType="com.example.fastboot.server.producems.vo.DemandConfirmStateCountVo">
        SELECT t1.demandConfiemedState,
               count(t1.demandConfiemedState) count
        FROM
            demanditem t1
            INNER JOIN nodes t2
        ON t1.nodeGuid = t2.guid
            RIGHT JOIN demandmanage t3 ON t3.guid = t2.moduleGuid
        WHERE
            t3.produceGuid = #{guid}
          AND t1.deleteFlag = 0
          AND t3.deleteFlag = 0
          AND t2.deleteFlag = 0
          AND t2.classType = 1
          AND t2.nodeType = 1
        GROUP BY
            t1.demandConfiemedState
    </select>
    <select id="countDevFinish" resultType="java.lang.Integer">
        select COUNT(dc.id)
        from demandtrace dc
        where dc.devlopFinishName!='' and dc.produceGuid=#{produceGuid}
          and dc.deleteFlag=0
    </select>
    <select id="listNodes" resultType="com.example.fastboot.server.producems.model.Nodes">
        select *
        from nodes inner join demandmanage on nodes.moduleGuid=demandmanage.guid
        <where>
            <if test="moduleGuid!=null and moduleGuid!=''">
                moduleGuid = #{moduleGuid}
            </if>
            and demandmanage.produceGuid=#{produceGuid}
            and nodes.deleteFlag = 0
        </where>
    </select>
    <select id="listDemandConfirmDetail" resultMap="demandItemNodes">
        SELECT
        *
        FROM
        demanditem
        INNER JOIN nodes ON nodes.guid = demanditem.nodeGuid
        WHERE
        nodes.moduleGuid = #{demandGuid} and nodes.classType=1 and nodeType=1
        <if test="demandConfirmedState!=null and demandConfirmedState[0]!=100 ">
            and demandConfiemedState in
            <foreach collection="demandConfirmedState" item="item" open="(" close=")"
                     index="index" separator=",">
                #{item}
            </foreach>
        </if>
        <if test="severity!='100' ">
            and severity=#{severity}
        </if>
        and demanditem.deleteFlag=0 and nodes.deleteFlag=0
    </select>
    <select id="countDemandTranceByNodeGuid" resultType="java.lang.Integer">
        SELECT count(*)
        from demandtrace dt
        where dt.nodeGuid = #{nodeGuid}
          and dt.deleteFlag = 0

    </select>
    <select id="getNodes" resultType="com.example.fastboot.server.producems.model.DemandItem">
        select * from demanditem where nodeGuid=#{guid}
    </select>
    <select id="listDemandTraceByProduce" resultType="com.example.fastboot.server.producems.model.Demandtrace">
        select t1.produceGuid
        from demandtrace t1
        inner join producemanage t2 on t1.produceGuid = t2.guid
        <where>
            t1.deleteFlag = 0 and t1.produceGuid !='' and t2.deleteFlag = 0
            <if test="producemanage.name !=null and producemanage.name!=''">
                and t2.name like CONCAT('%',#{producemanage.name},'%')
            </if>
            <if test="producemanage.number !=null and producemanage.number!=''">
                and t2.number like CONCAT('%',#{producemanage.number},'%')
            </if>
            <if test="produceGuids.length!=0">
                and t1.produceGuid in
                <foreach collection="produceGuids" separator="," close=")" open="(" item="item">
                    #{item}
                </foreach>
            </if>
        </where>
        group by t1.produceGuid
    </select>
    <select id="listAllDemandTraceByProduce"
            resultType="com.example.fastboot.server.producems.model.Demandtrace">
        select t1.*
        from demandtrace t1
        inner join producemanage t2 on t1.produceGuid = t2.guid
        <where>
            t1.deleteFlag = 0 and t1.produceGuid !='' and t2.deleteFlag = 0 and t1.dealState!=0
            <if test="producemanage.name !=null and producemanage.name!=''">
                and t2.name like CONCAT('%',#{producemanage.name},'%')
            </if>
            <if test="producemanage.number !=null and producemanage.number!=''">
                and t2.number like CONCAT('%',#{producemanage.number},'%')
            </if>
            <if test="produceGuids.length!=0">
                and t1.produceGuid in
                <foreach collection="produceGuids" separator="," close=")" open="(" item="item">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>
    <select id="listDistinctDemandTraceProduceGuid" resultType="java.lang.String">
        select distinct produceGuid
        from demandtrace
    </select>

    <select id="listDemandTrace" resultType="com.example.fastboot.server.producems.model.Demandtrace">
        select * from demandtrace
        where deleteFlag=0 and produceGuid = #{produceGuid} and dealState!=0
        <if test="demandType!=100 ">
            and demandType=#{demandType}
        </if>
        <if test="priority!=100 ">
            and priority=#{priority}
        </if>
        <if test="demandDescription!=null and demandDescription!=''">
            and demandDescription like concat('%',#{demandDescription},'%')
        </if>
        order by createTime desc
    </select>

</mapper>
